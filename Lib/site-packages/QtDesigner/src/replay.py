import subprocess
import json
from configsettings import *
from players import Player
from match import Match

class Replay:
	@staticmethod
	def parseReplay(filepath):
		replay_filepath = filepath.replace("./", "\\")
		command = f"{PATH} -map \"{replay_filepath}\""
		cmd_stdout = subprocess.check_output(
			command, shell=True, stderr=subprocess.STDOUT, stdin=subprocess.DEVNULL)
		return json.loads(cmd_stdout)

	@staticmethod
	def getPlayerFromReplay(match_as_json, index):
		race = match_as_json['Header']['Players'][index]['Race']['Name']
		name = match_as_json['Header']['Players'][index]["Name"]
		stats = match_as_json['Header']['Players'][index]
		apm = match_as_json['Computed']['PlayerDescs'][index]['APM']
		eapm = match_as_json['Computed']['PlayerDescs'][index]['EAPM']

		return Player(name, race, apm, eapm, stats)

	@staticmethod
	def getMatchFromReplay(match_as_json):
		#map names tend to have funky control characters in them that we need to strip
		map_name = match_as_json['Header']['Map'].encode("ascii", "ignore").decode('utf-8')
		match_date = match_as_json['Header']['StartTime']
		match_winner = match_as_json['Computed']['WinnerTeam']

		return Match(map_name, match_date, match_winner)