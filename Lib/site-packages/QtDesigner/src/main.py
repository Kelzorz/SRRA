import os
import subprocess
import json
import config
import srra
import analysis
import players
import replay
import match
import graph
import threading

replay_data = srra.ReplayData()


def push_current_match_to_replay_data(replay_path):
    match_as_json = replay.Replay.parse_replay(replay_path)

    if match.Match.is_valid(match_as_json):

        current_match = replay.Replay.get_match_data(match_as_json)
        replay_data.match_history.insert_match(
            current_match)


def main():

    replay_dirs = replay.Replay.find_replays()

    threads = []

    for replay_path in replay_dirs:
        try:
            t = threading.Thread(
                target=push_current_match_to_replay_data, args=[replay_path])
            t.start()
            threads.append(t)

        except Exception as e:
            replay_data.invalid_replays += 1
            print(e)
            return

    for th in threads:
        th.join()
    threads = []

    t = threading.Thread(target=replay_data.overall_win_ratio.set_win_ratio_from_match_history, args=[
                         replay_data.match_history.match_history])
    t.start()
    threads.append(t)
    t = threading.Thread(target=replay_data.set_average_apm, args=[
                         replay_data.match_history.match_history])
    t.start()
    threads.append(t)
    t = threading.Thread(target=replay_data.set_average_eapm, args=[
                         replay_data.match_history.match_history])
    t.start()
    threads.append(t)
    t = threading.Thread(target=replay_data.matchups.match_outcomes, args=[
                         replay_data.match_history.match_history])
    t.start()
    threads.append(t)
    for th in threads:
        th.join()

    list_of_apms = replay_data.match_history.get_list_of_apms()
    apm_graph = graph.Graph(list_of_apms)
    apm_graph.generate_apm_graph()

    return replay_data
